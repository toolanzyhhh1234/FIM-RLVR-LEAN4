# 1. Base Image: CUDA 12.4.1
# This is the "Sweet Spot": Supports H100/Blackwell, but still has official PyTorch wheels.
FROM nvidia/cuda:12.4.1-devel-ubuntu22.04

# 2. Setup Environment
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV CONDA_DIR=/opt/conda
ENV PATH=$CONDA_DIR/bin:$PATH

# 3. Install System Dependencies
# We include 'git' and 'ssh' so you don't need startup scripts.
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    python3-dev \
    git \
    wget \
    curl \
    openssh-server \
    tmux \
    screen \
    nano \
    htop \
    net-tools \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# 4. Install Miniconda (for optional conda-based workflows)
RUN wget -q https://repo.anaconda.com/miniconda/Miniconda3-py310_24.9.2-0-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p $CONDA_DIR && \
    rm -f /tmp/miniconda.sh && \
    $CONDA_DIR/bin/conda config --system --set auto_activate_base false

# 4. Set Python 3.10 as default
RUN ln -s /usr/bin/python3.10 /usr/bin/python

# 5. Install PyTorch (CUDA 12.4 Wheels)
# Pin torch/vision/audio to a cu124-compatible set to avoid dependency churn.
ARG TORCH_VERSION=2.4.1
ARG TORCHVISION_VERSION=0.19.1
ARG TORCHAUDIO_VERSION=2.4.1
RUN pip install --upgrade pip && \
    pip install \
      torch==${TORCH_VERSION}+cu124 \
      torchvision==${TORCHVISION_VERSION}+cu124 \
      torchaudio==${TORCHAUDIO_VERSION}+cu124 \
      --index-url https://download.pytorch.org/whl/cu124

# 5b. Install uv for faster Python package management
RUN pip install uv

# 6. Install FlashAttention-2 & vLLM (Pre-built Wheels)
# CRITICAL: Because we used CUDA 12.4 base, these will download binaries.
# No compilation = No 128GB RAM requirement = No Crash.
RUN pip install psutil && \
    pip install flash-attn --no-build-isolation
ARG VLLM_VERSION=0.11.1
RUN pip install vllm==${VLLM_VERSION}

# 7. Install VERL
# We clone it into /app/verl
WORKDIR /app
RUN git clone https://github.com/volcengine/verl.git
WORKDIR /app/verl
# Install verl deps + Megatron stack
RUN pip install -r requirements.txt
RUN pip install "numpy<2.0" "opencv-python-headless<4.12" megatron-core mbridge
# Install verl in editable mode
RUN pip install -e .

# 8. Setup SSH (The "Vast.ai Fix")
# Create the privilege separation directory and allow root login
RUN mkdir -p /var/run/sshd && \
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \
    # Set a fallback password (root:root) just in case keys fail
    echo 'root:root' | chpasswd

# 9. Performance Tuning Environment Variables
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
# Just in case you ever manually compile something later:
ENV MAX_JOBS=4

# 10. Default Command
# Run SSH in foreground. This keeps the container alive.
CMD ["/usr/sbin/sshd", "-D"]
